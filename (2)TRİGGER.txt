CREATE TRIGGER URUNDURUMUGUNCELLEME
ON SATIS AFTER INSERT
AS
BEGIN
DECLARE @ID INT 
SELECT @ID = URUNID FROM inserted
UPDATE URUNLER SET DURUM = 'BEKLEMEDE' WHERE URUNID = @ID
END


CREATE TRIGGER SATISTANKALDIRMA
ON SATIS AFTER UPDATE
AS
BEGIN
IF(UPDATE(DURUM))
BEGIN
DECLARE @ID INT
SELECT @ID = URUNID FROM deleted
UPDATE URUNLER SET DURUM = 'SATILDI' WHERE URUNID = @ID
END
END


CREATE TRIGGER IADEDURUMU
ON SATIS AFTER DELETE
AS
BEGIN
DECLARE @ID INT
SELECT @ID = URUNID FROM deleted
UPDATE URUNLER SET DURUM = 'SATIŞTA' WHERE URUNID = @ID
END

CREATE TRIGGER FIYATKONTROL
ON URUNLER AFTER INSERT
AS
BEGIN
DECLARE @ID INT 
DECLARE @FIYAT INT 
SELECT @ID = URUNID, @FIYAT = FIYAT FROM inserted
IF(@FIYAT > 1300)
BEGIN
PRINT 'GİRDİĞİNİZ FİYAT DEĞERİ LİMİTİN ÜSTÜNDE LÜTFEN 100000 DEN AZ DEĞER GİRİNİZ'
DELETE FROM URUNLER WHERE URUNID = @ID
END
END

CREATE TRIGGER ISLEMEKLEME
ON SATIS AFTER INSERT
AS
BEGIN
DECLARE @SATICIID INT
DECLARE @ALICIID INT
DECLARE @URUNID INT
DECLARE @FIYAT INT
DECLARE @GUNCELFIYATSATIS INT
DECLARE @GUNCELFIYATALIS INT
DECLARE @SATISADET INT
DECLARE @ALISADET INT
SELECT @ALICIID = ALICIID, @SATICIID = SATICIID, @URUNID = URUNID FROM inserted
SELECT @FIYAT = FIYAT FROM URUNLER WHERE URUNID = @URUNID
SELECT @GUNCELFIYATALIS =  ISLEMTOPLAMALIS FROM KULLANICILAR WHERE KULLANICIID = @ALICIID
SELECT @SATISADET =  SATISADET FROM KULLANICILAR WHERE KULLANICIID = @SATICIID
SELECT @ALISADET =  ALISADET FROM KULLANICILAR WHERE KULLANICIID = @ALICIID
SELECT @GUNCELFIYATSATIS =  ISLEMTOPLAMSATIS FROM KULLANICILAR WHERE KULLANICIID = @SATICIID
UPDATE KULLANICILAR SET ISLEMTOPLAMALIS = @GUNCELFIYATALIS + @FIYAT, ALISADET = @ALISADET + 1 WHERE KULLANICIID = @ALICIID
UPDATE KULLANICILAR SET ISLEMTOPLAMSATIS = @GUNCELFIYATSATIS + @FIYAT, SATISADET = @SATISADET + 1 WHERE KULLANICIID = @SATICIID
END
